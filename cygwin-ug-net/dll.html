<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<HTML
><HEAD
><TITLE
>Building and Using DLLs</TITLE
><META
NAME="GENERATOR"
CONTENT="Modular DocBook HTML Stylesheet version 1.13"><LINK
REL="HOME"
TITLE="Cygwin User's Guide"
HREF="cygwin-ug-net.html"><LINK
REL="PREVIOUS"
TITLE="Debugging Cygwin Programs"
HREF="gdb.html"><LINK
REL="NEXT"
TITLE="Linking Against DLLs"
HREF="dll-link.html"></HEAD
><BODY
><DIV
CLASS="NAVHEADER"
><TABLE
WIDTH="100%"
BORDER="0"
CELLPADDING="0"
CELLSPACING="0"
><TR
><TH
COLSPAN="3"
ALIGN="center"
>Cygwin User's Guide</TH
></TR
><TR
><TD
WIDTH="10%"
ALIGN="left"
VALIGN="bottom"
><A
HREF="gdb.html"
>Prev</A
></TD
><TD
WIDTH="80%"
ALIGN="center"
VALIGN="bottom"
></TD
><TD
WIDTH="10%"
ALIGN="right"
VALIGN="bottom"
><A
HREF="dll-link.html"
>Next</A
></TD
></TR
></TABLE
><HR
ALIGN="LEFT"
WIDTH="100%"></DIV
><H1
><A
NAME="DLL"
>Chapter 5. Building and Using DLLs</A
></H1
><DIV
CLASS="TOC"
><DL
><DT
><B
>Table of Contents</B
></DT
><DT
><A
HREF="dll.html#DLL-BUILD"
>Building DLLs</A
></DT
><DT
><A
HREF="dll-link.html"
>Linking Against DLLs</A
></DT
></DL
></DIV
><P
>DLLs are Dynamic Link Libraries, which means that they're linked
into your program at run time instead of build time.  There are three
parts to a DLL:</P
><P
></P
><UL
COMPACT="COMPACT"
><LI
><P
> the exports </P
></LI
><LI
><P
> the code and data </P
></LI
><LI
><P
> the import library </P
></LI
></UL
><P
>The code and data are the parts you write - functions,
variables, etc.  All these are merged together, like if you were
building one big object files, and put into the dll.  They are not
put into your .exe at all.</P
><P
>The exports contains a list of functions and variables that the
dll makes available to other programs.  Think of this as the list of
"global" symbols, the rest being hidden.  Normally, you'd create this
list by hand with a text editor, but it's possible to do it
automatically from the list of functions in your code.  The
<TT
CLASS="FILENAME"
>dlltool</TT
> program creates the exports section of
the dll from your text file of exported symbols.</P
><P
>The import library is a regular unix-like
<TT
CLASS="FILENAME"
>.a</TT
> library, but it only contains the tiny bit of
information needed to tell the OS how your program interacts with
("imports") the dll.  This information is linked into your
<TT
CLASS="FILENAME"
>.exe</TT
>.  This is also generated by
<TT
CLASS="FILENAME"
>dlltool</TT
>.</P
><H1
><A
NAME="DLL-BUILD"
>Building DLLs</A
></H1
><P
>OK, let's go through a simple example of how to build a dll.
For this example, we'll use a single file
<TT
CLASS="FILENAME"
>myprog.c</TT
> for the program
(<TT
CLASS="FILENAME"
>myprog.exe</TT
>) and a single file
<TT
CLASS="FILENAME"
>mydll.c</TT
> for the contents of the dll
(<TT
CLASS="FILENAME"
>mydll.dll</TT
>).</P
><P
>Now compile everything to objects:</P
><TABLE
BORDER="0"
BGCOLOR="#E0E0E0"
WIDTH="100%"
><TR
><TD
><PRE
CLASS="SCREEN"
>gcc -c myprog.c
gcc -c mydll.c</PRE
></TD
></TR
></TABLE
><P
>Unfortunately, the process for building a dll is, well, convoluted.
You have to run five commands, like this:</P
><TABLE
BORDER="0"
BGCOLOR="#E0E0E0"
WIDTH="100%"
><TR
><TD
><PRE
CLASS="SCREEN"
>ld --dll -o mydll.dll mydll.o -e _mydll_init@12 --base-file mydll.base
dlltool --base-file=mydll.base --def mydll.def --output-exp mydll.exp --dllname mydll.dll
ld --dll -o mydll.dll mydll.o -e _mydll_init@12 --base-file mydll.base mydll.exp
dlltool --base-file=mydll.base --def mydll.def --output-exp mydll.exp --dllname mydll.dll
ld --dll -o mydll.dll mydll.o -e _mydll_init@12 mydll.exp</PRE
></TD
></TR
></TABLE
><P
>The extra steps give <TT
CLASS="FILENAME"
>dlltool</TT
> the
opportunity to generate the extra sections (exports and relocation)
that a dll needs.  After this, you build the import library:</P
><TABLE
BORDER="0"
BGCOLOR="#E0E0E0"
WIDTH="100%"
><TR
><TD
><PRE
CLASS="SCREEN"
>dlltool --def mydll.def --dllname mydll.dll --output-lib mydll.a</PRE
></TD
></TR
></TABLE
><P
>Now, when you build your program, you link against the import
library:</P
><TABLE
BORDER="0"
BGCOLOR="#E0E0E0"
WIDTH="100%"
><TR
><TD
><PRE
CLASS="SCREEN"
>gcc -o myprog myprog.o mydll.a</PRE
></TD
></TR
></TABLE
><P
>Note that we linked with <B
CLASS="COMMAND"
>-e _rdll_init@12</B
>.
This tells the OS what the DLL's "entry point" is, and this is a
special function that coordinates bringing the dll to life withing the
OS.  The minimum function looks like this:</P
><TABLE
BORDER="0"
BGCOLOR="#E0E0E0"
WIDTH="100%"
><TR
><TD
><PRE
CLASS="SCREEN"
>#include &#60;windows.h&#62;

int WINAPI
rdll_init(HANDLE h, DWORD reason, void *foo)
{
  return 1;
}  </PRE
></TD
></TR
></TABLE
><DIV
CLASS="NAVFOOTER"
><HR
ALIGN="LEFT"
WIDTH="100%"><TABLE
WIDTH="100%"
BORDER="0"
CELLPADDING="0"
CELLSPACING="0"
><TR
><TD
WIDTH="33%"
ALIGN="left"
VALIGN="top"
><A
HREF="gdb.html"
>Prev</A
></TD
><TD
WIDTH="34%"
ALIGN="center"
VALIGN="top"
><A
HREF="cygwin-ug-net.html"
>Home</A
></TD
><TD
WIDTH="33%"
ALIGN="right"
VALIGN="top"
><A
HREF="dll-link.html"
>Next</A
></TD
></TR
><TR
><TD
WIDTH="33%"
ALIGN="left"
VALIGN="top"
>Debugging Cygwin Programs</TD
><TD
WIDTH="34%"
ALIGN="center"
VALIGN="top"
>&nbsp;</TD
><TD
WIDTH="33%"
ALIGN="right"
VALIGN="top"
>Linking Against DLLs</TD
></TR
></TABLE
></DIV
></BODY
></HTML
>