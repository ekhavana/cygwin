<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01//EN">
<HTML
><HEAD
><TITLE
>Building and Using DLLs</TITLE
><META
NAME="GENERATOR"
CONTENT="Modular DocBook HTML Stylesheet Version 1.76b+
"><LINK
REL="HOME"
TITLE="Cygwin User's Guide"
HREF="cygwin-ug-net.html"><LINK
REL="UP"
TITLE="Programming with Cygwin"
HREF="programming.html"><LINK
REL="PREVIOUS"
TITLE="Debugging Cygwin Programs"
HREF="gdb.html"><LINK
REL="NEXT"
TITLE="Defining Windows Resources"
HREF="windres.html"></HEAD
><BODY
CLASS="SECT1"
BGCOLOR="#FFFFFF"
TEXT="#000000"
LINK="#0000FF"
VLINK="#840084"
ALINK="#0000FF"
><DIV
CLASS="NAVHEADER"
><TABLE
SUMMARY="Header navigation table"
WIDTH="100%"
BORDER="0"
CELLPADDING="0"
CELLSPACING="0"
><TR
><TH
COLSPAN="3"
ALIGN="center"
>Cygwin User's Guide</TH
></TR
><TR
><TD
WIDTH="10%"
ALIGN="left"
VALIGN="bottom"
><A
HREF="gdb.html"
ACCESSKEY="P"
>&#60;&#60;&#60; Previous</A
></TD
><TD
WIDTH="80%"
ALIGN="center"
VALIGN="bottom"
>Programming with Cygwin</TD
><TD
WIDTH="10%"
ALIGN="right"
VALIGN="bottom"
><A
HREF="windres.html"
ACCESSKEY="N"
>Next &#62;&#62;&#62;</A
></TD
></TR
></TABLE
><HR
ALIGN="LEFT"
WIDTH="100%"></DIV
><DIV
CLASS="SECT1"
><H1
CLASS="SECT1"
><A
NAME="DLL">Building and Using DLLs</H1
><P
>DLLs are Dynamic Link Libraries, which means that they're linked
into your program at run time instead of build time.  There are three
parts to a DLL:</P
><P
></P
><UL
COMPACT="COMPACT"
><LI
><P
> the exports </P
></LI
><LI
><P
> the code and data </P
></LI
><LI
><P
> the import library </P
></LI
></UL
><P
>The code and data are the parts you write - functions,
variables, etc.  All these are merged together, like if you were
building one big object files, and put into the dll.  They are not
put into your .exe at all.</P
><P
>The exports contains a list of functions and variables that the
dll makes available to other programs.  Think of this as the list of
"global" symbols, the rest being hidden.  Normally, you'd create this
list by hand with a text editor, but it's possible to do it
automatically from the list of functions in your code.  The
<TT
CLASS="FILENAME"
>dlltool</TT
> program creates the exports section of
the dll from your text file of exported symbols.</P
><P
>The import library is a regular UNIX-like
<TT
CLASS="FILENAME"
>.a</TT
> library, but it only contains the tiny bit of
information needed to tell the OS how your program interacts with
("imports") the dll.  This information is linked into your
<TT
CLASS="FILENAME"
>.exe</TT
>.  This is also generated by
<TT
CLASS="FILENAME"
>dlltool</TT
>.</P
><DIV
CLASS="SECT2"
><H2
CLASS="SECT2"
><A
NAME="DLL-BUILD">Building DLLs</H2
><P
>OK, let's go through a simple example of how to build a dll.
For this example, we'll use a single file
<TT
CLASS="FILENAME"
>myprog.c</TT
> for the program
(<TT
CLASS="FILENAME"
>myprog.exe</TT
>) and a single file
<TT
CLASS="FILENAME"
>mydll.c</TT
> for the contents of the dll
(<TT
CLASS="FILENAME"
>mydll.dll</TT
>).</P
><P
>Now compile everything to objects:</P
><TABLE
BORDER="0"
BGCOLOR="#E0E0E0"
WIDTH="100%"
><TR
><TD
><PRE
CLASS="SCREEN"
>gcc -c myprog.c
gcc -c mydll.c</PRE
></TD
></TR
></TABLE
><P
>Fortunately, with the latest gcc and binutils the process for building a dll
is now much simpler. Say you want to build this minimal function in mydll.c:</P
><TABLE
BORDER="0"
BGCOLOR="#E0E0E0"
WIDTH="100%"
><TR
><TD
><PRE
CLASS="SCREEN"
>int WINAPI
mydll_init(HANDLE h, DWORD reason, void *foo)
{
  return 1;
}</PRE
></TD
></TR
></TABLE
><P
>First compile mydll.c to object code:</P
><TABLE
BORDER="0"
BGCOLOR="#E0E0E0"
WIDTH="100%"
><TR
><TD
><PRE
CLASS="SCREEN"
>gcc -c mydll.c</PRE
></TD
></TR
></TABLE
><P
>Then, tell gcc that it is building a shared library:</P
><TABLE
BORDER="0"
BGCOLOR="#E0E0E0"
WIDTH="100%"
><TR
><TD
><PRE
CLASS="SCREEN"
>gcc -shared -o mydll.dll mydll.o</PRE
></TD
></TR
></TABLE
><P
>That's it! However, if you are building a dll as an export library,
you will probably want to use the complete syntax:</P
><TABLE
BORDER="0"
BGCOLOR="#E0E0E0"
WIDTH="100%"
><TR
><TD
><PRE
CLASS="SCREEN"
>gcc -shared -o cyg${module}.dll \
    -Wl,--out-implib=lib${module}.dll.a \
    -Wl,--export-all-symbols \
    -Wl,--enable-auto-import \
    -Wl,--whole-archive ${old_lib} \
    -Wl,--no-whole-archive ${dependency_libs}</PRE
></TD
></TR
></TABLE
><P
>Where ${module} is the name of your DLL, ${old_lib} are all
your object files, bundled together in static libs or single object
files and the ${dependency_libs} are import libs you need to
link against, e.g '-lpng -lz -L/usr/local/special -lmyspeciallib'.</P
></DIV
><DIV
CLASS="SECT2"
><H2
CLASS="SECT2"
><A
NAME="DLL-LINK">Linking Against DLLs</H2
><P
>If you have an existing DLL already, you need to build a
Cygwin-compatible import library (The supplied ones should work, but
you might not have them) to link against.  Unfortunately, there is not
yet any tool to do this automatically.  However, you can get most of
the way by creating a .def file with these commands (you might need to
do this in <TT
CLASS="FILENAME"
>bash</TT
> for the quoting to work
correctly):</P
><TABLE
BORDER="0"
BGCOLOR="#E0E0E0"
WIDTH="100%"
><TR
><TD
><PRE
CLASS="SCREEN"
>echo EXPORTS &#62; foo.def
nm foo.dll | grep ' T _' | sed 's/.* T _//' &#62;&#62; foo.def</PRE
></TD
></TR
></TABLE
><P
>Note that this will only work if the DLL is not stripped.
Otherwise you will get an error message: "No symbols in
foo.dll".</P
><P
>Once you have the <TT
CLASS="FILENAME"
>.def</TT
> file, you can create
an import library from it like this:</P
><TABLE
BORDER="0"
BGCOLOR="#E0E0E0"
WIDTH="100%"
><TR
><TD
><PRE
CLASS="SCREEN"
>dlltool --def foo.def --dllname foo.dll --output-lib foo.a</PRE
></TD
></TR
></TABLE
></DIV
></DIV
><DIV
CLASS="NAVFOOTER"
><HR
ALIGN="LEFT"
WIDTH="100%"><TABLE
SUMMARY="Footer navigation table"
WIDTH="100%"
BORDER="0"
CELLPADDING="0"
CELLSPACING="0"
><TR
><TD
WIDTH="33%"
ALIGN="left"
VALIGN="top"
><A
HREF="gdb.html"
ACCESSKEY="P"
>&#60;&#60;&#60; Previous</A
></TD
><TD
WIDTH="34%"
ALIGN="center"
VALIGN="top"
><A
HREF="cygwin-ug-net.html"
ACCESSKEY="H"
>Home</A
></TD
><TD
WIDTH="33%"
ALIGN="right"
VALIGN="top"
><A
HREF="windres.html"
ACCESSKEY="N"
>Next &#62;&#62;&#62;</A
></TD
></TR
><TR
><TD
WIDTH="33%"
ALIGN="left"
VALIGN="top"
>Debugging Cygwin Programs</TD
><TD
WIDTH="34%"
ALIGN="center"
VALIGN="top"
><A
HREF="programming.html"
ACCESSKEY="U"
>Up</A
></TD
><TD
WIDTH="33%"
ALIGN="right"
VALIGN="top"
>Defining Windows Resources</TD
></TR
></TABLE
></DIV
></BODY
></HTML
>