<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<HTML
><HEAD
><TITLE
>Text and Binary modes</TITLE
><META
NAME="GENERATOR"
CONTENT="Modular DocBook HTML Stylesheet version 1.13"><LINK
REL="HOME"
TITLE="Cygwin User's Guide"
HREF="cygwin-ug-net.html"><LINK
REL="UP"
TITLE="Using Cygwin"
HREF="using.html"><LINK
REL="PREVIOUS"
TITLE="Using Cygwin"
HREF="using.html"><LINK
REL="NEXT"
TITLE="File permissions"
HREF="using-filemodes.html"></HEAD
><BODY
><DIV
CLASS="NAVHEADER"
><TABLE
WIDTH="100%"
BORDER="0"
CELLPADDING="0"
CELLSPACING="0"
><TR
><TH
COLSPAN="3"
ALIGN="center"
>Cygwin User's Guide</TH
></TR
><TR
><TD
WIDTH="10%"
ALIGN="left"
VALIGN="bottom"
><A
HREF="using.html"
>Prev</A
></TD
><TD
WIDTH="80%"
ALIGN="center"
VALIGN="bottom"
>Chapter 3. Using Cygwin</TD
><TD
WIDTH="10%"
ALIGN="right"
VALIGN="bottom"
><A
HREF="using-filemodes.html"
>Next</A
></TD
></TR
></TABLE
><HR
ALIGN="LEFT"
WIDTH="100%"></DIV
><H1
><A
NAME="USING-TEXTBINARY"
>Text and Binary modes</A
></H1
><H2
><A
NAME="AEN415"
>The Issue</A
></H2
><P
>On a UNIX system, when an application reads from a file it gets
exactly what's in the file on disk and the converse is true for writing.
The situation is different in the DOS/Windows world where a file can
be opened in one of two modes, binary or text.  In the binary mode the
system behaves exactly as in UNIX.  However in text mode there are
major differences:</P
><P
></P
><OL
COMPACT="COMPACT"
TYPE="a"
><LI
><P
>On writing in text mode, a NL (\n, ^J) is transformed into the 
sequence CR (\r, ^M) NL.</P
></LI
><LI
><P
>On reading in text mode, a CR followed by an NL is deleted and a ^Z
character signals the end of file.</P
></LI
></OL
><P
>This can wreak havoc with the seek/fseek calls since the number
of bytes actually in the file may differ from that seen by the
application.</P
><P
>The mode can be specified explicitly as explained in the Programming
section below.  In an ideal DOS/Windows world, all programs using lines as
records (such as <B
CLASS="COMMAND"
>bash</B
>, <B
CLASS="COMMAND"
>make</B
>,
<B
CLASS="COMMAND"
>sed</B
> ...) would open files (and change the mode of their
standard input and output) as text.  All other programs (such as
<B
CLASS="COMMAND"
>cat</B
>, <B
CLASS="COMMAND"
>cmp</B
>, <B
CLASS="COMMAND"
>tr</B
> ...)
would use binary mode.  In practice with Cygwin, programs that deal
explicitly with object files specify binary mode (this is the case of
<B
CLASS="COMMAND"
>od</B
>, which is helpful to diagnose CR problems).  Most
other programs (such as <B
CLASS="COMMAND"
>cat</B
>, <B
CLASS="COMMAND"
>cmp</B
>,
<B
CLASS="COMMAND"
>tr</B
>) use the default mode.</P
><H2
><A
NAME="AEN435"
>The default Cygwin behavior</A
></H2
><P
>The Cygwin system gives us some flexibility in deciding how files 
are to be opened when the mode is not specified explicitly:</P
><P
></P
><OL
TYPE="a"
><LI
><P
>If the file appears to reside on a file system that is mounted
(i.e. if its pathname starts with a directory displayed by
<B
CLASS="COMMAND"
>mount</B
>), then the default is specified by the mount
flag. If the file is a symbolic link, the mode of the target file system
applies.</P
></LI
><LI
><P
>If the file appears to reside on a file system that is not mounted
(as can happen when the path contains a drive letter), the default mode is
text, except if the <TT
CLASS="ENVAR"
>CYGWIN</TT
> environment variable contains
<TT
CLASS="LITERAL"
>binmode</TT
>.</P
><TABLE
CLASS="WARNING"
BORDER="1"
WIDTH="100%"
><TR
><TD
ALIGN="CENTER"
><B
>Warning!</B
></TD
></TR
><TR
><TD
ALIGN="LEFT"
><P
>In b20.1 only, a file will be opened
in binary mode if any of the following conditions hold:</P
><P
></P
><OL
COMPACT="COMPACT"
TYPE="1"
><LI
><P
>binary mode is specified in the open call</P
></LI
><LI
><P
><TT
CLASS="ENVAR"
>CYGWIN</TT
> contains <TT
CLASS="LITERAL"
>binmode</TT
></P
></LI
><LI
><P
>the file resides in a binary mounted partition</P
></LI
></OL
></TD
></TR
></TABLE
></LI
><LI
><P
>Pipes and non-file devices are always opened in binary mode.</P
></LI
><LI
><P
>When a Cygwin program is launched by a shell, its standard input,
output and error are in binary mode if the <TT
CLASS="ENVAR"
>CYGWIN</TT
> variable
contains <TT
CLASS="LITERAL"
>tty</TT
>, else in text mode, except if they are piped
or redirected.</P
><P
> When redirecting, the Cygwin shells uses rules (a-c). For
these shells the relevant value of <TT
CLASS="ENVAR"
>CYGWIN</TT
> is that at the time
the shell was launched and not that at the time the program is executed.
Non-Cygwin shells always pipe and redirect with binary mode. With
non-Cygwin shells the commands <B
CLASS="COMMAND"
> cat filename | program </B
>
and <B
CLASS="COMMAND"
> program &#60; filename </B
> are not equivalent when
<TT
CLASS="FILENAME"
>filename</TT
> is on a text-mounted partition. </P
></LI
></OL
><H2
><A
NAME="AEN469"
>Example</A
></H2
><P
>To illustrate the various rules, we provide a script to delete CRs
from files by using the <B
CLASS="COMMAND"
>tr</B
> program, which can only write
to standard output.</P
><TABLE
BORDER="0"
BGCOLOR="#E0E0E0"
WIDTH="100%"
><TR
><TD
><PRE
CLASS="SCREEN"
>#!/bin/sh
# Remove \r from the files given as arguments
for file in "$@"
do
  CYGWIN=binmode sh -c "tr -d \\\"\\\r\\\" &#60; '$file' &#62; c:tmpfile.tmp"
  if [ "$?" = "0" ]
  then
    rm "$file"
    mv c:tmpfile.tmp "$file"
  fi
done</PRE
></TD
></TR
></TABLE
><P
>This works irrespective of the mount because rule b) applies for the
path <TT
CLASS="FILENAME"
>c:tmpfile.tmp</TT
>.  According to rule d)
<TT
CLASS="ENVAR"
>CYGWIN</TT
> must be set before invoking the shell.  These
precautions are necessary because <B
CLASS="COMMAND"
>tr</B
> does not set its
standard output to binary mode. It would thus reintroduce \r when writing to
a file on a text mounted partition. The desired behavior can also be
obtained by using <B
CLASS="COMMAND"
>tr -d \r</B
> in a .bat file. </P
><H2
><A
NAME="AEN479"
>Binary or text?</A
></H2
><P
>UNIX programs that have been written for maximum portability
will know the difference between text and binary files and act
appropriately under Cygwin.  For those programs, the text mode default
is a good choice.  Programs included in official Cygnus distributions
should work well in the default mode. </P
><P
>Text mode makes it much easier to mix files between Cygwin and
Windows programs, since Windows programs will usually use the CRLF
format.  Unfortunately you may still have some problems with text
mode.  First, some of the utilities included with Cygwin do not yet
specify binary mode when they should, e.g. <B
CLASS="COMMAND"
>cat</B
> will
not work with binary files (input will stop at ^Z, CRs will be
introduced in the output). Second, you will introduce CRs in text
files you write, which can cause problems when moving them back to a
UNIX system. </P
><P
>If you are mounting a remote file system from a UNIX machine,
or moving files back and forth to a UNIX machine, you may want to
access them in binary mode as the text files found there will normally
be NL format anyway, and you would want any files put there by Cygwin
programs to be stored in a format that the UNIX machine will
understand.  Be sure to remove CRs from all Makefiles and
shell scripts and make sure that you only edit the files with
DOS/Windows editors that can cope with binary mode files.</P
><P
>Note that you can decide this on a disk by disk basis (for
example, mounting local disks in text mode and network disks in binary
mode).  You can also partition a disk, for example by mounting
<TT
CLASS="FILENAME"
>c:</TT
> in text mode, and <TT
CLASS="FILENAME"
>c:\home</TT
>
in binary mode.</P
><H2
><A
NAME="AEN488"
>Programming</A
></H2
><P
>In the <TT
CLASS="FUNCTION"
><B
>open()</B
></TT
> function call, binary mode can be
specified with the flag <TT
CLASS="LITERAL"
>O_BINARY</TT
> and text mode with
<TT
CLASS="LITERAL"
>O_TEXT</TT
>. These symbols are defined in
<TT
CLASS="FILENAME"
>fcntl.h</TT
>.</P
><P
>In the <TT
CLASS="FUNCTION"
><B
>fopen()</B
></TT
> function call, binary mode can be
specified by adding a <TT
CLASS="LITERAL"
>b</TT
> to the mode string. There is no
direct way to specify text mode.</P
><P
>The mode of a file can be changed by the call
<TT
CLASS="FUNCTION"
><B
>setmode(fd,mode)</B
></TT
> where <TT
CLASS="LITERAL"
>fd</TT
> is a file
descriptor (an integer) and <TT
CLASS="LITERAL"
>mode</TT
> is
<TT
CLASS="LITERAL"
>O_BINARY</TT
> or <TT
CLASS="LITERAL"
>O_TEXT</TT
>. The function
returns <TT
CLASS="LITERAL"
>O_BINARY</TT
> or <TT
CLASS="LITERAL"
>O_TEXT</TT
> depending
on the mode before the call, and <TT
CLASS="LITERAL"
>EOF</TT
> on error.</P
><DIV
CLASS="NAVFOOTER"
><HR
ALIGN="LEFT"
WIDTH="100%"><TABLE
WIDTH="100%"
BORDER="0"
CELLPADDING="0"
CELLSPACING="0"
><TR
><TD
WIDTH="33%"
ALIGN="left"
VALIGN="top"
><A
HREF="using.html"
>Prev</A
></TD
><TD
WIDTH="34%"
ALIGN="center"
VALIGN="top"
><A
HREF="cygwin-ug-net.html"
>Home</A
></TD
><TD
WIDTH="33%"
ALIGN="right"
VALIGN="top"
><A
HREF="using-filemodes.html"
>Next</A
></TD
></TR
><TR
><TD
WIDTH="33%"
ALIGN="left"
VALIGN="top"
>Using Cygwin</TD
><TD
WIDTH="34%"
ALIGN="center"
VALIGN="top"
><A
HREF="using.html"
>Up</A
></TD
><TD
WIDTH="33%"
ALIGN="right"
VALIGN="top"
>File permissions</TD
></TR
></TABLE
></DIV
></BODY
></HTML
>